from src.llm_client import get_completion

# --- æº«æš–ä¸”ä¹¾æ·¨çš„ System Prompt ---
system_prompt = """
ä½ æ˜¯ä¸€ä½æº«æš–ä¸”å°ˆæ¥­çš„æƒ…æ„Ÿè«®å•†å¸«ï¼Œå°ˆç²¾æ–¼ Gottman Method èˆ‡ä¾é™„ç†è«–ã€‚
ä½ çš„ä»»å‹™æ˜¯é–±è®€ä½¿ç”¨è€…çš„å¿ƒè²ï¼Œæä¾›æœ‰æ·±åº¦çš„å¿ƒç†åˆ†æã€‚

ç‚ºäº†è®“ä½¿ç”¨è€…åœ¨çµ‚ç«¯æ©Ÿé–±è®€èˆ’é©ï¼Œè«‹åš´æ ¼éµå®ˆä»¥ä¸‹ã€Œè¦–è¦ºæ½”ç™–ã€æ’ç‰ˆè¦å‰‡ï¼š
1. **çµ•å°ç¦æ­¢ä½¿ç”¨æ˜Ÿè™Ÿ (*)**ï¼šæ¸…å–®ç¬¦è™Ÿè«‹æ”¹ç”¨æ¸›è™Ÿ (-)ï¼Œä¸è¦ç”¨æ˜Ÿè™Ÿã€‚
2. **ç¦æ­¢ä½¿ç”¨ç²—é«” (**)**ï¼šä¸è¦æŠŠé‡é»åŠ ç²—ï¼Œä¿æŒæ–‡å­—å¹³é †ä¹¾æ·¨ã€‚
3. **å€å¡Šæ¸…æ™°**ï¼šæ¨™é¡Œä½¿ç”¨ # æˆ– ##ï¼Œæ¯å€‹å€å¡Šä¹‹é–“è«‹ç•™ä¸€è¡Œç©ºç™½ã€‚

è«‹ä¾ç…§ä»¥ä¸‹ Markdown æ¨¡æ¿è¼¸å‡ºï¼š

# ğŸ›‹ï¸ æƒ…æ„Ÿé—œä¿‚åˆ†æå ±å‘Š

> [è«‹åœ¨é€™è£¡å¯«ä¸€å¥æº«æš–çš„é–‹å ´ç™½ï¼ŒåŒç†ä½¿ç”¨è€…çš„ç•¶ä¸‹æƒ…ç·’]

## 1. æ ¸å¿ƒä¾é™„èˆ‡éœ€æ±‚
- ä¾é™„é¡å‹åˆ¤å®šï¼š(ç„¦æ…®å‹ / é€ƒé¿å‹ / å®‰å…¨å‹)
- æ·±åº¦è§£æï¼š(è«‹è§£é‡‹ä½¿ç”¨è€…çš„å“ªäº›è©±åæ˜ äº†é€™å€‹ä¾é™„é¡å‹çš„å…§åœ¨ææ‡¼ï¼Œç´„ 50-80 å­—)
- å…§åœ¨æ¸´æœ›ï¼š(ç¸½çµä½¿ç”¨è€…çœŸæ­£æƒ³å¾ä¼´ä¾¶èº«ä¸Šå¾—åˆ°ä»€éº¼)

## 2. è¡çªæ¨¡å¼è­˜åˆ¥ (Gottman å››é¨å£«)
(è«‹åˆ—å‡ºåµæ¸¬åˆ°çš„é …ç›®ï¼Œè‹¥ç„¡å‰‡ä¸åˆ—)

- [é¨å£«åç¨±]
  åŸæ–‡ï¼š"[å¼•ç”¨åŸæ–‡]"
  è§£æï¼š(è«‹è§£é‡‹é€™å€‹è¡Œç‚ºç‚ºä½•ç™¼ç”Ÿï¼Œä»¥åŠå®ƒå°é—œä¿‚é€ æˆçš„å…·é«”å‚·å®³)

## 3. æƒ¡æ€§å¾ªç’°æ¨¡å‹
- äº’å‹•èˆæ­¥ï¼š(æè¿° A åšäº†ä»€éº¼å°è‡´ B åæ‡‰ï¼ŒB çš„åæ‡‰åˆå¦‚ä½•æ¿€æ€’ Aï¼Œå½¢æˆè¿´åœˆ)

## 4. å…·é«”ä¿®å¾©å»ºè­°
- åœæ­¢åšçš„è¡Œç‚ºï¼š(å…·é«”å»ºè­°)
- é–‹å§‹åšçš„å˜—è©¦ï¼š(å…·é«”å»ºè­°)
- æ›å¥è©±èªªç·´ç¿’ï¼š
  âŒ åŸå¥ï¼š"[å¼•ç”¨ä¸€å¥åŸè©±]"
  âœ… è©¦è‘—èªªï¼š"[é‹ç”¨è»Ÿæ€§é–‹å ´èˆ‡æˆ‘è¨Šæ¯çš„ä¿®æ­£ç‰ˆæœ¬]"

"""

def start_chat():
    # --- ä½ æŒ‡å®šçš„å®¢è£½åŒ–é–‹å ´ç™½ ---
    print("-" * 60)
    print("\nå—¨ï¼æˆ‘æ˜¯æ‚¨çš„å°ˆå±¬ AI æƒ…æ„Ÿè«®è©¢å¸«â¤ï¸")
    print("ä¾†è·Ÿæˆ‘åˆ†äº«ä¸€ä¸‹ä½ æœ€è¿‘ç…©æƒ±çš„å¿ƒæƒ…å•é¡Œæˆ–èŠå¤©ç´€éŒ„å§ï¼")
    print("æˆ‘å°‡æœƒç”¨å¿ƒç†å­¸ä¸­çš„ Gottman Method (æœ«æ—¥å››é¨å£«) èˆ‡ Attachment Theory (ä¾é™„ç†è«–) å¹«æ‚¨åˆ†ææ‚¨çš„æƒ…æ„Ÿèˆ‡è§£æ±ºæ–¹å¼ï¼")
    print("-" * 60)
    print("ä¸éï¼Œè«‹æ‚¨æ³¨æ„ä»¥ä¸‹è¦å‰‡ï¼š")
    print("1. é€™æ˜¯ã€Œå¤šè¡Œè¼¸å…¥æ¨¡å¼ã€ï¼šè¼¸å…¥å®Œä¸€è¡ŒæŒ‰ Enter å¯ä»¥ç¹¼çºŒæ‰“ä¸‹ä¸€è¡Œã€‚")
    print("2. ç•¶æ‚¨å…¨éƒ¨è¬›å®Œå¾Œï¼Œè«‹åœ¨æ–°çš„ä¸€è¡Œè¼¸å…¥ 'DONE' (æˆ– 'åˆ†æ') ä¾†é–‹å§‹åˆ†æã€‚")
    print("3. æœ€å¾Œè¼¸å…¥ 'exit' æˆ– 'quit' é›¢é–‹ç¨‹å¼ã€‚")
    print("-" * 60 + "\n")

    # åˆå§‹å°è©±ç´€éŒ„
    messages = [
        {"role": "system", "content": system_prompt}
    ]

    while True:
        print("[è«‹é–‹å§‹è¼¸å…¥æ‚¨çš„å•é¡Œæˆ–æ˜¯èŠå¤©ç´€éŒ„...]")
        user_buffer = []
        
        while True:
            line = input(">> ")
            
            # æª¢æŸ¥çµæŸæŒ‡ä»¤
            if line.strip().upper() in ["DONE", "åˆ†æ"]:
                break
            # æª¢æŸ¥é›¢é–‹æŒ‡ä»¤
            if line.strip().lower() in ["exit", "quit"]:
                print("è«®å•†çµæŸï¼Œå¸Œæœ›èƒ½å¸¶çµ¦æ‚¨ä¸€é»åŠ›é‡ã€‚ğŸ‘‹")
                return 
            
            if line.strip(): # å¿½ç•¥ç´”ç©ºè¡Œ
                user_buffer.append(line)

        # çµ„åˆä½¿ç”¨è€…è¼¸å…¥çš„æ‰€æœ‰è¡Œ
        full_text = "\n".join(user_buffer)

        if not full_text:
            print("âš ï¸ æ‚¨æ²’æœ‰è¼¸å…¥ä»»ä½•å…§å®¹ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚")
            continue

        print("\n(AI æ­£åœ¨è©³ç´°é–±è®€ä¸¦åˆ†ææ‚¨çš„å®Œæ•´è¨Šæ¯ï¼Œè«‹ç¨å€™...)\n")
        
        # æŠŠæ•´æ®µè©±åŠ å…¥ç´€éŒ„
        messages.append({"role": "user", "content": full_text})

        # å‘¼å« AI
        reply = get_completion(messages)

        if reply:
            print(reply) # ç›´æ¥å°å‡º AI å›è¦† (å·²ç¶“æ ¼å¼åŒ–å¥½äº†)
            print("\n" + "=" * 60 + "\n") # åˆ†éš”ç·š
            
            # æŠŠ AI çš„å›è¦†ä¹ŸåŠ å…¥ç´€éŒ„ï¼Œä¿æŒå°è©±è¨˜æ†¶
            messages.append({"role": "assistant", "content": reply})

if __name__ == "__main__":
    start_chat()